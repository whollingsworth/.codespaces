#!/bin/sh

CODESPACES_HOME="/workspaces/.codespaces/.persistedshare/dotfiles"
MONOREPO_HOME="/workspaces/monorama"

############
# HOMEBREW #
############

# APT-based install of GNU Stow is failing in Ubuntu 24.04 based images, but I
# am also installing it via brew
BREW_COMMAND="/home/linuxbrew/.linuxbrew/bin/brew" # `brew` is not in path since `config.fish` is not sourced
BREWFILE_PATH="${CODESPACES_HOME}/Brewfile"        # ${HOMEBREW_BUNDLE_FILE} is not exported since `config.fish` is not sourced

/bin/bash -c "$(curl --fail --silent --show-error --location https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
${BREW_COMMAND} bundle install --file="${BREWFILE_PATH}"


####################
# RESTORE DOTFILES #
####################

DOTFILES_HOME="${HOME}/.dotfiles"

git clone https://github.com/wthollingsworth/.dotfiles.git "${DOTFILES_HOME}" >/dev/null 2>&1

# Install dotfiles with stow
#sudo apt install stow
for dir in "${DOTFILES_HOME}"/*/; do
  stow --dir="${DOTFILES_HOME}" --target="${HOME}" "$(basename "${dir}")"
done

####################
# INSTALL SOFTWARE #
####################

NPM_COMMAND="/home/codespace/nvm/current/bin/npm"

RUBIES_HOME="/home/codespace/.rubies"

# LSP - Vue
npm_packages=$(cat <<EOF
  "@vue/language-server"
	"typescript"
	"@vtsls/language-server"
	"@vue/typescript-plugin"
	"vue"
	"tsc"
EOF
)
echo "${npm_packages}" | xargs -n1 ${NPM_COMMAND} install --global >/dev/null 2>&1

# LSP - Ruby
find /workspaces/monorama/apps -maxdepth 3 -name '.ruby-version' | \
  xargs cat | \
  grep -o -E '[0-9]\.[0-9]+\.[0-9]+' | \
  sort -u | \
  xargs -I{} sh -c "${RUBIES_HOME}/ruby-{}/bin/gem install ruby-lsp ruby-lsp-rails rubocop panolint panolint-rails" # >/dev/null 2>&1"

cat <<-EOF >"${MONOREPO_HOME}/.git/info/exclude"
	.helix/*
EOF

cp --recursive "${CODESPACES_HOME}/.codespaces.helix" "${MONOREPO_HOME}/.helix"

#################
# SET THE SHELL #
#################
. "${CODESPACES_HOME}/install-fish.sh"
cp "${CODESPACES_HOME}/config.codespaces.fish" "${HOME}/.config/fish/config.local.fish" # Panorama shell includes
sudo chsh --shell "/usr/bin/fish" "$(whoami)"
